name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd AI_Challenge_21/server
          npm install

      - name: Index documentation
        run: |
          cd AI_Challenge_21/server
          node -e "
          import('./ragMcpClient.js').then(async (module) => {
            await module.callDocumentTool('index_documents', {
              directory: './documents',
              file_patterns: ['**/*.md'],
              index_name: 'docs_index'
            });
          });
          "
        env:
          REPO_PATH: ${{ github.workspace }}

      - name: Run AI Review
        id: review
        run: |
          cd AI_Challenge_21/server
          node -e "
          import('./prReviewService.js').then(async (module) => {
            const result = await module.reviewPullRequest(
              '${{ github.event.pull_request.base.ref }}',
              '${{ github.event.pull_request.head.ref }}'
            );
            console.log(JSON.stringify(result, null, 2));
          });
          " > review_output.json
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          REPO_PATH: ${{ github.workspace }}

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('AI_Challenge_21/server/review_output.json', 'utf8'));
            
            const body = `## ?? AI Code Review
            
            **Files reviewed:** ${review.filesCount}
            
            ${review.fileReviews.map(r => `### ?? ${r.file}\n${r.review}`).join('\n\n')}
            
            ---
            
            ## Summary
            ${review.summary}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
