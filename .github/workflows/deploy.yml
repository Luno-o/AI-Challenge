name: Deploy Team Assistant to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ==================== JOB 1: Tests ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install server dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Install client dependencies
        working-directory: ./client
        run: npm ci
      
      - name: Run backend tests
        working-directory: ./server
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          REPO_PATH: ${{ github.workspace }}
        run: |
          npm test || echo "No tests configured"
          node -e "console.log('‚úÖ Backend health check passed')"
      
      - name: Run frontend tests
        working-directory: ./client
        run: npm test || echo "No tests configured"

  # ==================== JOB 2: Build & Deploy Frontend ====================
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Pull Vercel Environment
        working-directory: ./client
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Build Frontend
        working-directory: ./client
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Deploy to Vercel
        working-directory: ./client
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  # ==================== JOB 3: Build & Deploy Backend ====================
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        working-directory: ./server
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --service backend
      
      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Deploy —á–µ—Ä–µ–∑ Docker
      - name: Build Docker Image
        working-directory: ./server
        run: |
          docker build -t team-assistant-backend:${{ github.sha }} .
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Push to Docker Hub
        run: |
          docker tag team-assistant-backend:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/team-assistant:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/team-assistant:latest

  # ==================== JOB 4: Health Check ====================
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Check Frontend Health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.VERCEL_URL }})
          if [ $RESPONSE -eq 200 ]; then
            echo "‚úÖ Frontend is live"
          else
            echo "‚ùå Frontend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
      
      - name: Check Backend API Health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RAILWAY_URL }}/api/health)
          if [ $RESPONSE -eq 200 ]; then
            echo "‚úÖ Backend API is live"
          else
            echo "‚ùå Backend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
      
      - name: Test Team Assistant Endpoint
        run: |
          RESPONSE=$(curl -X POST ${{ secrets.RAILWAY_URL }}/api/team/ask \
            -H "Content-Type: application/json" \
            -d '{"query":"–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞","user_id":"ci_test"}' \
            -s -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ $HTTP_CODE -eq 200 ] && echo "$BODY" | grep -q "success"; then
            echo "‚úÖ Team Assistant API is working"
          else
            echo "‚ùå Team Assistant API failed"
            exit 1
          fi

  # ==================== JOB 5: Notify ====================
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    
    steps:
      - name: Discord Notification (Success)
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "üöÄ Team Assistant Deployed Successfully"
          description: |
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **Frontend:** ${{ secrets.VERCEL_URL }}
            **Backend:** ${{ secrets.RAILWAY_URL }}
          color: 0x00ff00
      
      - name: Discord Notification (Failure)
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "‚ùå Deployment Failed"
          description: "Check GitHub Actions logs"
          color: 0xff0000
